import { Agent } from '../../../agent'
import { IAction } from '../../../interfaces'

export const TEMPLATE_SIZE_13: any = { "0": { "spawn": [{ "x": 3, "y": 1 }] }, "1": { "extension": [{ "x": -5, "y": 5 }, { "x": -4, "y": 5 }, { "x": -3, "y": 5 }, { "x": -2, "y": 5 }, { "x": -1, "y": 5 }] }, "2": { "extension": [{ "x": -5, "y": 2 }, { "x": -5, "y": 3 }, { "x": -5, "y": 4 }, { "x": -3, "y": 4 }, { "x": -1, "y": 4 }] }, "3": { "rampart": [{ "x": -6, "y": -6 }, { "x": -5, "y": -6 }, { "x": -4, "y": -6 }, { "x": -3, "y": -6 }, { "x": -2, "y": -6 }, { "x": -1, "y": -6 }, { "x": 0, "y": -6 }, { "x": 1, "y": -6 }, { "x": 2, "y": -6 }, { "x": 3, "y": -6 }, { "x": 4, "y": -6 }, { "x": 5, "y": -6 }, { "x": 6, "y": -6 }, { "x": -6, "y": -5 }, { "x": 6, "y": -5 }, { "x": -6, "y": -4 }, { "x": 6, "y": -4 }, { "x": -6, "y": -3 }, { "x": 6, "y": -3 }, { "x": -6, "y": -2 }, { "x": 6, "y": -2 }, { "x": -6, "y": -1 }, { "x": 6, "y": -1 }, { "x": -6, "y": 0 }, { "x": 6, "y": 0 }, { "x": -6, "y": 1 }, { "x": 6, "y": 1 }, { "x": -6, "y": 2 }, { "x": 6, "y": 2 }, { "x": -6, "y": 3 }, { "x": 6, "y": 3 }, { "x": -6, "y": 4 }, { "x": 6, "y": 4 }, { "x": -6, "y": 5 }, { "x": 6, "y": 5 }, { "x": -6, "y": 6 }, { "x": -5, "y": 6 }, { "x": -4, "y": 6 }, { "x": -3, "y": 6 }, { "x": -2, "y": 6 }, { "x": -1, "y": 6 }, { "x": 0, "y": 6 }, { "x": 1, "y": 6 }, { "x": 2, "y": 6 }, { "x": 3, "y": 6 }, { "x": 4, "y": 6 }, { "x": 5, "y": 6 }, { "x": 6, "y": 6 }], "road": [{ "x": 0, "y": -5 }, { "x": 0, "y": -4 }, { "x": 1, "y": -3 }, { "x": 2, "y": -3 }, { "x": 3, "y": -3 }, { "x": 4, "y": -3 }, { "x": 0, "y": -2 }, { "x": 4, "y": -2 }, { "x": 0, "y": -1 }, { "x": 4, "y": -1 }, { "x": 5, "y": -1 }, { "x": -3, "y": 0 }, { "x": -2, "y": 0 }, { "x": -1, "y": 0 }, { "x": 0, "y": 0 }, { "x": 1, "y": 0 }, { "x": 2, "y": 0 }, { "x": 3, "y": 0 }, { "x": 4, "y": 0 }, { "x": -5, "y": 1 }, { "x": -4, "y": 1 }, { "x": 0, "y": 1 }, { "x": 4, "y": 1 }, { "x": 5, "y": 1 }, { "x": -4, "y": 2 }, { "x": 0, "y": 2 }, { "x": 4, "y": 2 }, { "x": -4, "y": 3 }, { "x": -3, "y": 3 }, { "x": -2, "y": 3 }, { "x": -1, "y": 3 }, { "x": 1, "y": 3 }, { "x": 2, "y": 3 }, { "x": 3, "y": 3 }, { "x": 4, "y": 3 }, { "x": 0, "y": 4 }, { "x": 0, "y": 5 }], "tower": [{ "x": 1, "y": -2 }], "storage": [{ "x": -1, "y": 1 }], "extension": [{ "x": 5, "y": 2 }, { "x": 5, "y": 3 }, { "x": 1, "y": 4 }, { "x": 3, "y": 4 }, { "x": 5, "y": 4 }, { "x": 1, "y": 5 }, { "x": 2, "y": 5 }, { "x": 3, "y": 5 }, { "x": 4, "y": 5 }, { "x": 5, "y": 5 }] }, "4": { "extension": [{ "x": 2, "y": -5 }, { "x": 3, "y": -5 }, { "x": 4, "y": -5 }, { "x": 5, "y": -5 }, { "x": 3, "y": -4 }, { "x": 5, "y": -4 }, { "x": 5, "y": -3 }, { "x": 5, "y": -2 }, { "x": -5, "y": 0 }, { "x": 5, "y": 0 }], "tower": [{ "x": 2, "y": -2 }], "link": [{ "x": -1, "y": 2 }] }, "5": { "extension": [{ "x": -5, "y": -5 }, { "x": -4, "y": -5 }, { "x": -3, "y": -5 }, { "x": -2, "y": -5 }, { "x": -1, "y": -5 }, { "x": 1, "y": -5 }, { "x": -5, "y": -4 }, { "x": 1, "y": -4 }, { "x": -5, "y": -3 }, { "x": -5, "y": -2 }], "road": [{ "x": -4, "y": -3 }, { "x": -3, "y": -3 }, { "x": -2, "y": -3 }, { "x": -1, "y": -3 }, { "x": -4, "y": -2 }, { "x": -5, "y": -1 }, { "x": -4, "y": -1 }], "lab": [{ "x": -3, "y": -2 }, { "x": -2, "y": -2 }, { "x": -1, "y": -2 }], "terminal": [{ "x": -4, "y": 0 }] }, "6": { "extension": [{ "x": -4, "y": -4 }, { "x": -3, "y": -4 }, { "x": -2, "y": -4 }, { "x": -1, "y": -4 }, { "x": 2, "y": -4 }, { "x": 4, "y": -4 }, { "x": -4, "y": 4 }, { "x": -2, "y": 4 }, { "x": 2, "y": 4 }, { "x": 4, "y": 4 }], "lab": [{ "x": -3, "y": -1 }, { "x": -2, "y": -1 }, { "x": -1, "y": -1 }], "tower": [{ "x": 3, "y": -2 }], "spawn": [{ "x": 2, "y": 1 }] }, "7": { "extension": [{ "x": 0, "y": -3 }, { "x": 0, "y": 3 }], "lab": [{ "x": -3, "y": 1 }, { "x": -2, "y": 1 }, { "x": -3, "y": 2 }, { "x": -2, "y": 2 }], "tower": [{ "x": 1, "y": -1 }, { "x": 2, "y": -1 }, { "x": 3, "y": -1 }], "spawn": [{ "x": 1, "y": 1 }], "nuker": [{ "x": 1, "y": 2 }], "powerSpawn": [{ "x": 2, "y": 2 }], "observer": [{ "x": 3, "y": 2 }] } }
export const TEMPLATE_SIZE_11: any = { "0": { "spawn": [{ "x": 0, "y": -4 }] }, "1": { "extension": [{ "x": -5, "y": -5 }, { "x": -4, "y": -5 }, { "x": -3, "y": -5 }, { "x": -2, "y": -5 }, { "x": -1, "y": -5 }] }, "2": { "extension": [{ "x": -3, "y": -4 }, { "x": -2, "y": -4 }, { "x": -4, "y": -3 }, { "x": -2, "y": -3 }, { "x": -1, "y": -3 }], "tower": [{ "x": -1, "y": -2 }] }, "3": { "extension": [{ "x": 1, "y": -5 }, { "x": 2, "y": -5 }, { "x": 3, "y": -5 }, { "x": -5, "y": -4 }, { "x": -5, "y": -3 }, { "x": -5, "y": -2 }, { "x": -4, "y": -2 }, { "x": -3, "y": -2 }, { "x": -5, "y": -1 }, { "x": -3, "y": -1 }] }, "4": { "extension": [{ "x": 4, "y": -5 }, { "x": 5, "y": -5 }, { "x": 2, "y": -4 }, { "x": 3, "y": -4 }, { "x": 5, "y": -4 }, { "x": 4, "y": -3 }, { "x": 5, "y": -3 }, { "x": 4, "y": -2 }, { "x": 5, "y": -2 }, { "x": 5, "y": -1 }], "tower": [{ "x": -2, "y": -1 }], "link": [{ "x": 0, "y": -1 }], "storage": [{ "x": 0, "y": 0 }] }, "5": { "extension": [{ "x": 1, "y": -3 }, { "x": 2, "y": -3 }, { "x": 3, "y": -2 }, { "x": 3, "y": -1 }, { "x": -5, "y": 1 }, { "x": -5, "y": 2 }, { "x": -5, "y": 3 }, { "x": -5, "y": 4 }, { "x": -5, "y": 5 }, { "x": -4, "y": 5 }], "terminal": [{ "x": 0, "y": 1 }], "lab": [{ "x": -1, "y": 2 }, { "x": -2, "y": 3 }, { "x": -1, "y": 3 }] }, "6": { "extension": [{ "x": 5, "y": 3 }, { "x": 5, "y": 4 }, { "x": -3, "y": 5 }, { "x": -2, "y": 5 }, { "x": -1, "y": 5 }, { "x": 1, "y": 5 }, { "x": 2, "y": 5 }, { "x": 3, "y": 5 }, { "x": 4, "y": 5 }, { "x": 5, "y": 5 }], "tower": [{ "x": 1, "y": -2 }] }, "7": { "extension": [{ "x": 3, "y": 1 }, { "x": 5, "y": 1 }, { "x": 3, "y": 2 }, { "x": 4, "y": 2 }, { "x": 5, "y": 2 }, { "x": 1, "y": 3 }, { "x": 2, "y": 3 }, { "x": 4, "y": 3 }, { "x": 2, "y": 4 }, { "x": 3, "y": 4 }], "spawn": [{ "x": 4, "y": 0 }, { "x": 0, "y": 4 }], "tower": [{ "x": 2, "y": 1 }, { "x": 1, "y": 2 }], "powerSpawn": [{ "x": -4, "y": 0 }], "nuker": [{ "x": -1, "y": 0 }], "observer": [{ "x": 1, "y": 0 }], "lab": [{ "x": -3, "y": 1 }, { "x": -2, "y": 1 }, { "x": -4, "y": 2 }, { "x": -3, "y": 2 }, { "x": -4, "y": 3 }, { "x": -3, "y": 4 }, { "x": -2, "y": 4 }] } }

export const RoomPlanner: IAction = {
    name: 'room-planner',
    run(room: Room) {
        if (room.memory.center == null) {
            return [Agent.UNSHIFT_AND_CONTINUE, FindBasePosition.name]
        }

        if (Game.time % 10 === 0) {
            return [Agent.UNSHIFT_AND_CONTINUE, RoomConstructor.name]
        }

        return Agent.WAIT_NEXT_TICK
    }
}

export const FindBasePosition: IAction = {
    name: 'find-base-position',
    run(room: Room) {
        const MAP_WIDTH_HEIGHT = 11

        let data: any = {
            get(x: number, y: number) {
                const key = `${x},${y}`

                return this[key] || (this[key] = { x, y })
            }
        }

        // calculate max square from this cell
        for (let y = 0; y < 50; y++) {
            for (let x = 0; x < 50; x++) {
                const node: any = data.get(x, y)

                node.size = 0
                node.terrain = Game.map.getTerrainAt(x, y, room.name)

                if (node.terrain === 'wall') {
                    node.size = 0

                } else if (x === 0 || y === 0) {
                    node.size = 1

                } else {
                    const west = data.get(x - 1, y)
                    const north = data.get(x, y - 1)
                    const northwest = data.get(x - 1, y - 1)

                    if (west.size === north.size && north.size === northwest.size) {
                        node.size = Math.min(MAP_WIDTH_HEIGHT, north.size + 1)

                    } else {
                        node.size = _.min([west.size, north.size, northwest.size]) + 1
                    }
                }
            }
        }

        // calculate swamps inside each square
        for (let y = 0; y < 50; y++) {
            for (let x = 0; x < 50; x++) {
                const node: any = data.get(x, y)

                node.swamps = -1

                // skip small squares
                if (node.size >= MAP_WIDTH_HEIGHT) {
                    let swamps = 0

                    for (let _y = y - MAP_WIDTH_HEIGHT + 1; _y <= y; _y++) {
                        for (let _x = x - MAP_WIDTH_HEIGHT + 1; _x <= x; _x++) {
                            if (data.get(_x, _y).terrain === 'swamp') {
                                swamps += 1
                            }
                        }
                    }

                    node.swamps = swamps
                }
            }
        }

        // room's center position
        const centers = [
            [24, 24], [25, 24],
            [24, 25], [25, 25]
        ]

        // translate positions and calculate distance to the center of the room
        for (const key in data) {
            if (data[key].size >= MAP_WIDTH_HEIGHT) {
                data[key].x -= Math.floor(MAP_WIDTH_HEIGHT / 2)
                data[key].y -= Math.floor(MAP_WIDTH_HEIGHT / 2)
                data[key].dist = _.min(centers.map(pos => Math.hypot(pos[0] - data[key].x, pos[1] - data[key].y)))
            }
        }

        // get best candidate
        const best = _.values(data)
            .filter((node: any) => node.size >= MAP_WIDTH_HEIGHT)
            .sort((a: any, b: any) => {
                if (a.swamps !== b.swamps) {
                    return a.swamps - b.swamps
                }

                return a.dist - b.dist
            })

        // if none is found, we should try with a smaller template
        if (best.length) {
            room.memory.center = {
                x: best[0].x,
                y: best[0].y
            }
        }

        return Agent.SHIFT_AND_CONTINUE
    }
}

export const RoomConstructor: IAction = {
    name: 'room-constructor',
    run(room: Room) {
        const center = room.memory.center

        if (center == null) {
            return Agent.SHIFT_AND_STOP
        }

        for (let i = 1; i < room.controller!.level; i++) {
            const templateLevel = TEMPLATE_SIZE_11[i]

            for (const type in templateLevel) {
                for (const position of templateLevel[type]) {
                    const structures = room.lookForAt(LOOK_STRUCTURES, center.x + position.x, center.y + position.y)

                    if (structures.length) {
                        continue
                    }

                    const constructions = room.lookForAt(LOOK_CONSTRUCTION_SITES, center.x + position.x, center.y + position.y)

                    if (constructions.length) {
                        return Agent.SHIFT_AND_STOP
                    }

                    const result = room.createConstructionSite(center.x + position.x, center.y + position.y, type)

                    if (result === OK) {
                        return Agent.SHIFT_AND_STOP
                    }
                }
            }
        }

        return Agent.SHIFT_AND_STOP
    }
}
